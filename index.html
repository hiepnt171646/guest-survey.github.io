<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kh·∫£o s√°t t√≠nh c√°ch</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; }
    .container { max-width: 800px; margin:0 auto; padding:20px; }
    .question-card { background:white; color:#333; border-radius:20px; padding:25px; margin-bottom:20px; }
    .options button { padding:10px 15px; margin:5px; border-radius:10px; border:1px solid #ccc; cursor:pointer; background:#f8f9fa; }
    .options button.selected { border:2px solid #667eea; background:#f0f4ff; color:#667eea; }
    #submitBtn { padding:15px 40px; font-weight:bold; border:none; border-radius:50px; cursor:pointer; background:linear-gradient(135deg, #43e97b, #38f9d7); color:white; }
    #resultCard { background:white; color:#333; border-radius:25px; padding:30px; margin-top:20px; display:none; text-align:center; }
    #progressBar { width:100%; height:10px; background:rgba(255,255,255,0.3); border-radius:10px; overflow:hidden; margin-bottom:10px; }
    #progressFill { height:100%; width:0%; background: linear-gradient(90deg, #43e97b, #38f9d7); transition: width 0.3s; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center;">üß† Kh·∫£o s√°t t√≠nh c√°ch</h1>
    <p style="text-align:center;">Kh√°m ph√° t√≠nh c√°ch c·ªßa b·∫°n qua nh·ªØng c√¢u h·ªèi th√∫ v·ªã. Ch·ªâ m·∫•t v√†i ph√∫t!</p>

    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="questions"></div>
    <div style="text-align:center;">
      <button id="submitBtn">üéØ Xem k·∫øt qu·∫£</button>
    </div>

    <div id="resultCard">
      <h2 id="resultTitle"></h2>
      <p id="resultDesc"></p>
      <button onclick="restartSurvey()">L√†m l·∫°i kh·∫£o s√°t</button>
    </div>
  </div>

  <!-- Firebase JS SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKSZ90zsIYiHeahFdbL0M5HK4lzIvsBU4",
      authDomain: "quiz-97ec7.firebaseapp.com",
      projectId: "quiz-97ec7",
      storageBucket: "quiz-97ec7.appspot.com",
      messagingSenderId: "233024726562",
      appId: "1:233024726562:web:26e86b04d2481451588c7b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const questions = [
      { question: "B·∫°n th√≠ch l√†m g√¨ v√†o cu·ªëi tu·∫ßn?", options: [ { type:"A", text:"ƒê·ªçc s√°ch" }, { type:"B", text:"Ch∆°i th·ªÉ thao" }, { type:"C", text:"ƒêi d·∫°o ngo√†i tr·ªùi" }, { type:"D", text:"V·∫Ω ho·∫∑c nghe nh·∫°c" } ] },
      { question: "M√†u s·∫Øc b·∫°n th√≠ch nh·∫•t?", options: [ { type:"A", text:"Xanh d∆∞∆°ng" }, { type:"B", text:"ƒê·ªè" }, { type:"C", text:"Xanh l√°" }, { type:"D", text:"V√†ng" } ] },
      { question: "B·∫°n th∆∞·ªùng ƒë∆∞·ª£c b·∫°n b√® nh·∫≠n x√©t l√†?", options: [ { type:"A", text:"Tr·∫ßm t√≠nh" }, { type:"B", text:"Ho·∫°t b√°t" }, { type:"C", text:"Tho·∫£i m√°i" }, { type:"D", text:"S√°ng t·∫°o" } ] },
      { question: "B·∫°n mu·ªën ƒëi du l·ªãch ·ªü ƒë√¢u?", options: [ { type:"A", text:"Th∆∞ vi·ªán l·ªõn" }, { type:"B", text:"S√¢n v·∫≠n ƒë·ªông" }, { type:"C", text:"R·ª´ng n√∫i" }, { type:"D", text:"Ph·ªë ngh·ªá thu·∫≠t" } ] },
    ];

    const personalities = {
      A:"B·∫°n l√† ng∆∞·ªùi th√≠ch t√¨m t√≤i, ham h·ªçc h·ªèi v√† s·ªëng n·ªôi t√¢m.",
      B:"B·∫°n nƒÉng ƒë·ªông, th√≠ch v·∫≠n ƒë·ªông v√† giao ti·∫øp x√£ h·ªôi.",
      C:"B·∫°n y√™u thi√™n nhi√™n, ∆∞a kh√°m ph√° v√† t·ª± do.",
      D:"B·∫°n s√°ng t·∫°o, l·∫°c quan v√† th√≠ch ngh·ªá thu·∫≠t."
    };

    let answers = {};
    const questionsDiv = document.getElementById('questions');
    const progressFill = document.getElementById('progressFill');
    const submitBtn = document.getElementById('submitBtn');
    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const resultDesc = document.getElementById('resultDesc');

    function renderQuestions() {
      questionsDiv.innerHTML = '';
      questions.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question-card';
        qDiv.innerHTML = `<h3>${idx+1}. ${q.question}</h3>`;
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        q.options.forEach(o => {
          const btn = document.createElement('button');
          btn.innerText = o.text;
          btn.onclick = () => selectOption(idx, o);
          if(answers[idx]?.type === o.type) btn.classList.add('selected');
          optionsDiv.appendChild(btn);
        });
        qDiv.appendChild(optionsDiv);
        questionsDiv.appendChild(qDiv);
      });
      updateProgress();
    }

    function selectOption(qIdx, option) {
      answers[qIdx] = option;
      renderQuestions();
    }

    function updateProgress() {
      const prog = Object.keys(answers).length / questions.length * 100;
      progressFill.style.width = prog + '%';
    }

    async function saveSurveyResult(answers, topType) {
      try {
        const answersArray = questions.map((q, idx) => ({
          question: q.question,
          selected: answers[idx],
        }));
        await addDoc(collection(db, "surveyResponses"), {
          answers: answersArray,
          result: topType,
          createdAt: serverTimestamp(),
        });

        const totalsRef = doc(db, "surveyStats", "totals");
        await updateDoc(totalsRef, { [topType]: increment(1) });
      } catch(err) {
        console.error("Error saving response:", err);
      }
    }

    function submitSurvey() {
      if(Object.keys(answers).length < questions.length) {
        alert("Vui l√≤ng tr·∫£ l·ªùi t·∫•t c·∫£ c√¢u h·ªèi!");
        return;
      }
      const counts = {};
      Object.values(answers).forEach(o => {
        counts[o.type] = (counts[o.type] || 0) + 1;
      });
      const topType = Object.keys(counts).reduce((a,b) => counts[a]>counts[b]?a:b);
      resultTitle.innerText = `T√≠nh c√°ch c·ªßa b·∫°n: Nh√≥m ${topType}`;
      resultDesc.innerText = personalities[topType];
      resultCard.style.display = 'block';
      window.scrollTo({top:0, behavior:'smooth'});
      saveSurveyResult(answers, topType);
    }

    function restartSurvey() {
      answers = {};
      resultCard.style.display = 'none';
      renderQuestions();
    }

    submitBtn.onclick = submitSurvey;
    renderQuestions();
  </script>
</body>
</html>
